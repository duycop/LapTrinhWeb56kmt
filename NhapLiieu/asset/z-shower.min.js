//**************************/
//*  author: Do Duy Cop    */
//*  create: 16.10.2023    */
//**************************/
$(document).ready(function(){let t="/api.ashx",n="/mp3/";var e,i,o,a=!1;function s(t,n,e){var i="";if(e){var o=new Date;o.setTime(o.getTime()+864e5*e),i="; expires="+o.toUTCString()}document.cookie=t+"="+(n||"")+i+"; path=/"}function c(t,n){window.localStorage.setItem(t,n)}function d(t){var n,e=function t(n){for(var e=n+"=",i=document.cookie.split(";"),o=0;o<i.length;o++){for(var a=i[o];" "==a.charAt(0);)a=a.substring(1,a.length);if(0==a.indexOf(e))return a.substring(e.length,a.length)}return null}(t);return(null==e||""==e||void 0==e)&&(e=(n=t,window.localStorage.getItem(n))),e}function l(n,e){$.post(t,{action:n},function(t){i=t,e(t)})}function r(n,i){if(!a){f();return}$.post(t,{action:n,id:i},function(t){t.ok?e.close():toastr.warning(t.msg)})}function u(){var t=200,n=$(".jconfirm-box-container");function e(i){n.css("transform","translate(0px, -"+i+"px)"),i<t/2-200&&setTimeout(function(){e(i+50)},1)}t=n[0].parentElement.offsetParent.offsetHeight}function f(){a||$.alert({title:'<div class="badge bg-primary">Bạn chưa đăng nhập</div>',content:"H\xe3y đăng nhập để điều khiển",closeIcon:!0,columnClass:"s",escapeKey:"cancel",buttons:{ok:{text:"Đăng nhập lu\xf4n",btnClass:"btn-blue",keys:["enter","n"],action:function(){v()}},cancel:{text:"Cancel",keys:["esc","c","C"],btnClass:"btn-red"}}})}function h(t){var n,e;return(e=(n=t>=60?parseInt(t/60):0)>=60?parseInt(n/60):0,(n%=60)<10&&(n="0"+n),(t%=60)<10&&(t="0"+t),e>0)?(e<10&&(e="0"+e),e+":"+n+":"+t):n+":"+t}var g=new class t{constructor(){this.queue=[]}enqueue(t){return this.queue.unshift(t)}dequeue(){return this.queue.pop()}peek(){return this.queue[this.length-1]}get length(){return this.queue.length}isEmpty(){return 0===this.queue.length}checkExist(t){for(var n of this.queue)if(n.id==t.id)return!0;return!1}enqueue2(t){this.checkExist(t)||this.enqueue(t)}clear(){for(var t in this.queue)void 0==this.queue[t].vip&&this.queue.splice(t,1)}remove(t){if(!this.isEmpty()){for(var n in this.queue)if(this.queue[n].id==t.id){this.queue.splice(n,1);return}}}},b=0;function p(t){if(t.ok){var e=[];for(var i of t.data)1==i.tt?($("#p"+i.id).addClass("tam"),$("#p"+i.id+" .time").html("P"+i.id+": "+h(i.ss)),i.ss>900&&($("#p"+i.id).addClass("over"),e.push(i.id))):($("#p"+i.id).removeClass("tam").removeClass("over"),$("#p"+i.id+" .time").html("P"+i.id),g.remove(i));if(e.length>0){var o=e.join(", ");g.clear(),g.enqueue2({id:o})}if(!b&&!g.isEmpty()){var a,i=g.dequeue();a="Hết giờ ph\xf2ng tắm "+i.id,$.post(n,{text:a},function(t){!function t(n,e){if(!b){var i=new Audio(n);i.play().then(()=>{b=1,toastr.info("Đang n\xf3i ra loa, h\xe3y bật loa!<br>"+e)}).catch(t=>{console.log(t),toastr.warning("H\xe3y bật loa v\xe0 CLICK v\xe0o tr\xecnh duyệt để cho ph\xe9p n\xf3i ra loa nh\xe9")}),i.addEventListener("ended",function(){setTimeout(function(){b=0},3e3)})}}(n+JSON.parse(t).fn,a)})}}else toastr.warning(t.msg)}function m(){a?($(".login_info").html("Xin ch\xe0o&nbsp;<b>"+o.fullname+"</b>"),$("#cmdLogin").hide(),$("#cmdLogout,.login_info, .btn-thong-ke").removeClass("not-show"),$("#cmdLogout,.login_info, .btn-thong-ke").show(),$(".login_info").click(function(){!function n(){if(!a){f();return}$.alert({title:'<div class="badge bg-primary">Xin ch\xe0o <b>'+o.fullname+"</b></div>",content:'<div id="list-user"></div><p>C\xe1c t\xednh năng d\xe0nh cho bạn</p>',closeIcon:!0,columnClass:"m",escapeKey:"cancel",buttons:{add_user:{text:"Th\xeam user",btnClass:"btn-primary",isHidden:!0,action:function(){return alert("Nếu l\xe0 admin th\xec hiện form th\xeam user mới"),!1}},change_pw:{text:"Đổi mật khẩu",btnClass:"btn-blue",action:function(){return alert("đổi mật khẩu của người d\xf9ng hiện tại, chưa code"),!1}},cancel:{text:"Close",keys:["esc","c","C"],btnClass:"btn-red"}},onContentReady:function(){100==o.role&&(this.buttons.add_user.show(),$.post(t,{action:"list_user"},function(t){if(t.ok){var n='<h4>Danh s\xe1ch user</h4><table class="table table-hover"><thead><tr class="table-info"><th>STT</th><th>uid</th><th>fullname</th><th>Role</th><th>Last login</th><th>Action</th></tr></thead><tbody>',e=0;for(var i of t.data){n+="<tr>",n+='<td align="center">'+ ++e+"</td>",n+="<td>"+i.uid+"</td>",n+="<td>"+i.fullname+"</td>",n+="<td>"+i.rolename+"</td>",n+="<td>"+i.last+"</td>";var o='<button class="btn btn-sm btn-warning btn-action-user" data-action="change-pw" data-uid="'+i.uid+'">PW</button>';o+=' <button class="btn btn-sm btn-danger btn-action-user" data-action="del-user" data-uid="'+i.uid+'">Del</button>',n+="<td>"+o+"</td></tr>",n+="</tr>"}n+="</tbody></table>",$("#list-user").html(n),$(".btn-action-user").click(function(){var t=$(this).data("action"),n=$(this).data("uid");alert(["coding",t,n,])})}}))}})}()})):($(".login_info").html(""),$("#cmdLogin").removeClass("not-show"),$("#cmdLogin").show(),$("#cmdLogout").hide())}function v(){$("#cmdLogin").addClass("active");let n=d("uid");n||(n=""),void 0===n&&(n="");let e=$.confirm({lazyOpen:!0,closeIcon:!0,title:'<div class="badge bg-primary"><i class="fa fa-key" aria-hidden="true"></i> Login system</div>',content:'<form action="" class="formName"><div class="form-group"><label>Username:</label><input type="text" placeholder="Enter Username" class="uid form-control" value="'+n+'" required /></div><div class="form-group"><label>Password:</label><input type="password" placeholder="Enter password" class="pwd form-control" required /></div></form>',escapeKey:"cancel",buttons:{formSubmit:{text:"Login",btnClass:"btn-blue cmd-submit",action:function(){let n=this.$content.find(".uid").val(),i=this.$content.find(".pwd").val();if(""==n)return this.$content.find(".uid").focus(),!1;if(""==i)return this.$content.find(".pwd").focus(),!1;let d=$.confirm({title:"Submit and Process...",content:"Please wait a few second...",buttons:{ok:{}}});return $.post(t,{action:"do_login",uid:n,pwd:i},function(t){d.close(),(a=t.ok)?(o=t,m(),localStorage.logined=JSON.stringify(t),c("uid",t.uid),c("ck",t.cookie),s("uid",t.uid),s("ck",t.cookie,30),e.close()):(m(),$.confirm({title:"Warning",escapeKey:"ok",content:t.msg,autoClose:"OK|5000",escapeKey:"OK",buttons:{OK:{text:"Close",keys:["enter","t"],btnClass:"btn-red",action:function(){}}},onDestroy:function(){e.$content.find(".pwd").focus()}}))}),!1}},cancel:{text:"Close",btnClass:"btn-red"}},onClose:function(){$("#cmdLogin").removeClass("active")},onContentReady:function(){let t=this;d("uid"),""==n?t.$content.find(".uid").focus():t.$content.find(".pwd").focus(),t.$content.find(".uid").keyup(function(n){13===n.keyCode&&(""==t.$content.find(".uid").val()?this.$content.find(".uid").focus():t.$content.find(".pwd").focus())}),t.$content.find(".pwd").keyup(function(n){13===n.keyCode&&(""==t.$content.find(".uid").val()?this.$content.find(".uid").focus():""==t.$content.find(".pwd").val()?this.$content.find(".pwd").focus():$.find(".cmd-submit")[0].click())})}});e.open()}let y,k;toastr.options={closeButton:!0,debug:!1,newestOnTop:!0,progressBar:!1,positionClass:"toast-top-right",preventDuplicates:!0,onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},l("monitor",function t(n){for(var o of n.data)1==o.loai?($("#p"+o.id).addClass("nam"),$("#p"+o.id).prop("title","Ph\xf2ng nam "+o.id)):($("#p"+o.id).addClass("nu"),$("#p"+o.id).prop("title","Ph\xf2ng nữ "+o.id)),$("#p"+o.id).data("pid",o.id),$("#p"+o.id).html('<div class="time">P'+o.id+"</div>");$(".nam,.nu").click(function(){if(!a){f();return}var t=$(this).data("pid");e=$(this).hasClass("tam")?$.alert({closeIcon:!0,columnClass:"s",escapeKey:"cancel",title:'<div class="badge bg-primary">Ph\xf2ng&nbsp;'+t+"&nbsp;đ\xe3&nbsp;tắm&nbsp;xong?</div>",content:"X\xe1c nhận đ\xe3 tắm xong ph\xf2ng "+t+" ??",buttons:{ok:{btnClass:"btn-blue",text:"Tắm xong P."+t,keys:["enter","t","x","T","X"],action:function(){return r("tam_xong",t),!1}},nham:{btnClass:"btn-warning",text:'<span title="Nhầm c\xf3 thể hủy trong v\xf2ng 2 ph\xfat">Nhầm</span>',keys:["n","N"],isHidden:!0,isDisabled:!0,action:function(){return r("huy_phong",t),!1}},mp3:{btnClass:"btn-info",text:"Loa",keys:["m","p","3","M","P"],action:function(){g.clear(),g.enqueue({id:t,vip:1})}},cancel:{btnClass:"btn-red",text:"Cancel",keys:["esc","c","C"],action:function(){e.close()}}},onContentReady:function(){for(var n of(u(),i.data))if(n.id==t){n.ss<150?(this.buttons.nham.show(),this.buttons.nham.enable()):this.buttons.nham.hide();break}}}):$.alert({closeIcon:!0,escapeKey:"cancel",title:'<div class="badge bg-primary">V\xe0o tắm Ph\xf2ng '+t+"?</div>",content:"X\xe1c nhận v\xe0o tắm mới?",buttons:{ok:{btnClass:"btn-blue",text:"V\xe0o tắm P."+t,keys:["enter","v","t","V","T"],action:function(){return r("vao_tam",t),!1}},cancel:{btnClass:"btn-red jconfirm-closeIcon",text:"Cancel",keys:["esc","c","C"],action:function(){e.close()}}},onContentReady:function(){u()}})})}),setInterval(function(){l("monitor",p)},500),document.addEventListener&&document.addEventListener("contextmenu",function(t){t.preventDefault()},!1),$(".btn-thong-ke").click(function(){!function n(){if(!a){f();return}$.post(t,{action:"thong_ke"},function(n){if(n.ok){var e='<table class="table table-hover">';e+='<thead><tr class="table-info fw-bold"><td align=center>STT</td><td align=center>Ng\xe0y</td><td align=center>Số lượt tắm</td><td align=center>Số lượt hủy</td></tr></thead><tbody>';var i=0,o=0,a=0;for(var s of n.data)e+='<tr class="btn-report-detail" data-date="'+s.date+'"><td align=center>'+ ++a+"</td><td align=center>"+s.date+'</td><td align=center><span class="badge rounded-pill bg-primary">'+s.tam+'</span></td><td align=center><span class="badge rounded-pill bg-danger">'+s.huy+"</span></td></tr>",i+=s.tam,o+=s.huy;e+='<tr class="table-warning fw-bold"><td align=right colspan=2>Tổng:</td><td align=center><span class="badge rounded-pill bg-primary">'+i+'</span></td><td align=center><span class="badge rounded-pill bg-danger">'+o+"</span></td></tr>",e+="</tbody></table>",$.alert({closeIcon:!0,escapeKey:"ok",title:'<div class="badge bg-primary">Thống k\xea tổng hợp</div>',content:e,buttons:{ok:{text:"Đ\xf3ng lại",btnClass:"btn-info"}},onContentReady:function(){u(),$(".btn-report-detail").click(function(){var n=$(this).data("date");$.post(t,{action:"report_detail",date:n},function(t){var e='<table class="table table-hover table-striped">';e+='<thead><tr class="table-info fw-bold"><td align=center>stt</td><td align=center>Ph\xf2ng</td><td align=center>Giờ v\xe0o</td><td align=center>Giờ ra</td><td align=center>Số ph\xfat</td><td align=center>Hủy</td></tr></thead><tbody>';var i=0;for(var o of t.data){var a=o.tin.split(" ");a.length>1&&(a=a[1]);var s=o.tout.split(" ");s=s.length>1?s[1]:"(đang tắm)",e+='<tr class="'+(o.huy?"table-danger":"")+'"><td align=center>'+ ++i+'</td><td align=center><span class="badge rounded-pill '+(o.loai?"bg-primary":"bg-info")+'">'+(o.loai?"Nam":"Nữ")+" "+o.pid+"</span></td><td align=center>"+a+"</td><td align=center>"+s+'</td><td align=center><span class="badge rounded-pill '+(o.use<=15?"bg-primary":o.use<=20?"bg-warning":"bg-danger")+'">'+o.use+"</span></td><td align=center>"+(o.huy?"Hủy":"")+"</td></tr>"}e+="</tbody></table>",$.alert({closeIcon:!0,columnClass:"l",escapeKey:"ok",title:'<div class="badge bg-primary">Thống k\xea chi tiết ng\xe0y '+n+"</div>",content:e,buttons:{ok:{text:"Đ\xf3ng lại",btnClass:"btn-info"}}})})})}})}else toastr.warning(n.msg)})}()}),$("#cmdLogin").click(function(){v()}),$("#cmdLogout").click(function(){$.post(t,{action:"do_logout"},function(t){if(t.ok){a=!1,gui_first=0;document.cookie="ck=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";localStorage.removeItem("ck"),localStorage.clear(),m(),window.location.href="/"}})}),y=d("ck"),k=d("uid"),null!=y&&null!=k?$.post(t,{action:"check_logined"},function(t){(a=t.ok)&&(o=t,localStorage.logined=JSON.stringify(t),c("uid",t.uid),c("ck",t.cookie),s("uid",t.uid),s("ck",t.cookie,30)),m()}):(a=!1,m())});